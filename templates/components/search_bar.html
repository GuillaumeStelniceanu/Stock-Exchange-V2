<!-- templates/components/search_bar.html -->
<div class="search-bar-component">
    <div class="search-bar-wrapper">
        <div class="search-icon-wrapper">
            <i class="fas fa-search"></i>
        </div>
        <input type="text" 
               class="search-bar-input" 
               id="{% if input_id %}{{ input_id }}{% else %}search-bar-input{% endif %}"
               placeholder="{% if placeholder %}{{ placeholder }}{% else %}Rechercher une action (ex: AAPL, MSFT, TTE.PA)...{% endif %}"
               value="{% if value %}{{ value }}{% endif %}"
               autocomplete="off">
        <button class="search-bar-button" onclick="searchBarSubmit{% if input_id %}{{ input_id|title }}{% endif %}()">
            <i class="fas fa-chart-line"></i>
            <span>Analyser</span>
        </button>
    </div>
    
    <div id="{% if suggestions_id %}{{ suggestions_id }}{% else %}search-bar-suggestions{% endif %}" 
         class="search-bar-suggestions">
    </div>
    
    <!-- Popular stocks quick access -->
    <div class="search-quick-actions">
        <span class="quick-label">Actions populaires:</span>
        <button class="quick-stock-btn" onclick="quickAnalyze('AAPL')">
            <i class="fab fa-apple"></i> AAPL
        </button>
        <button class="quick-stock-btn" onclick="quickAnalyze('MSFT')">
            <i class="fab fa-microsoft"></i> MSFT
        </button>
        <button class="quick-stock-btn" onclick="quickAnalyze('GOOGL')">
            <i class="fab fa-google"></i> GOOGL
        </button>
        <button class="quick-stock-btn" onclick="quickAnalyze('TSLA')">
            <i class="fas fa-car"></i> TSLA
        </button>
        <button class="quick-stock-btn" onclick="quickAnalyze('TTE.PA')">
            <i class="fas fa-gas-pump"></i> TTE
        </button>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    const inputId = '{% if input_id %}{{ input_id }}{% else %}search-bar-input{% endif %}';
    const suggestionsId = '{% if suggestions_id %}{{ suggestions_id }}{% else %}search-bar-suggestions{% endif %}';
    
    // Submit function
    window.searchBarSubmit{% if input_id %}{{ input_id|title }}{% endif %} = function() {
        const input = document.getElementById(inputId);
        const ticker = input.value.trim().toUpperCase();
        if (ticker) {
            window.location.href = `/analyse?ticker=${ticker}`;
        }
    };
    
    // Quick analyze function
    window.quickAnalyze = function(ticker) {
        window.location.href = `/analyse?ticker=${ticker}`;
    };
    
    // Get input element
    const input = document.getElementById(inputId);
    const suggestions = document.getElementById(suggestionsId);
    
    if (!input || !suggestions) return;
    
    // Enter key support
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            searchBarSubmit{% if input_id %}{{ input_id|title }}{% endif %}();
        }
    });
    
    // Search suggestions with debounce
    let searchTimeout;
    input.addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();
        
        if (query.length < 2) {
            hideSuggestions();
            return;
        }
        
        searchTimeout = setTimeout(async () => {
            try {
                const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.suggestions && data.suggestions.length > 0) {
                    showSuggestions(data.suggestions);
                } else {
                    showNoResults();
                }
            } catch (error) {
                console.error('Search error:', error);
                hideSuggestions();
            }
        }, 300);
    });
    
    function showSuggestions(items) {
        let html = '';
        items.slice(0, 8).forEach(item => {
            const market = item.market || (item.symbol.includes('.PA') ? 'EU' : 'US');
            html += `
                <div class="search-suggestion-item" onclick="quickAnalyze('${item.symbol}')">
                    <div class="suggestion-main-info">
                        <span class="suggestion-ticker-text">${item.symbol}</span>
                        <span class="suggestion-name-text">${item.name || item.symbol}</span>
                    </div>
                    <span class="suggestion-market-badge ${market.toLowerCase()}">${market}</span>
                </div>
            `;
        });
        
        suggestions.innerHTML = html;
        suggestions.classList.add('active');
    }
    
    function showNoResults() {
        suggestions.innerHTML = `
            <div class="search-no-results">
                <i class="fas fa-search"></i>
                <p>Aucun résultat trouvé</p>
            </div>
        `;
        suggestions.classList.add('active');
    }
    
    function hideSuggestions() {
        suggestions.classList.remove('active');
    }
    
    // Close suggestions when clicking outside
    document.addEventListener('click', function(e) {
        const searchBar = input.closest('.search-bar-component');
        if (searchBar && !searchBar.contains(e.target)) {
            hideSuggestions();
        }
    });
    
    // Keyboard navigation in suggestions
    let selectedIndex = -1;
    
    input.addEventListener('keydown', function(e) {
        const items = suggestions.querySelectorAll('.search-suggestion-item');
        
        if (items.length === 0) return;
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = (selectedIndex + 1) % items.length;
            updateSelection(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = selectedIndex <= 0 ? items.length - 1 : selectedIndex - 1;
            updateSelection(items);
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
            e.preventDefault();
            items[selectedIndex].click();
        }
    });
    
    function updateSelection(items) {
        items.forEach((item, index) => {
            if (index === selectedIndex) {
                item.classList.add('selected');
                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('selected');
            }
        });
    }
})();
</script>